<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Fira+Code&display=swap" rel="stylesheet">
  <title>Setun Simulador de Computador Tern√°rio</title>
  <style>
    :root {
      --panel-bg: #ffffff;
      --background-color: #f4f7f9;
      --text-color: #343a40;
      --text-color-light: #6c757d;
      --border-color: #dee2e6;
      --indicator-off-bg: #e9ecef;
      --indicator-off-border: #ced4da;
      --indicator-on-bg: #ffc107;
      --indicator-on-border: #e0a800;
      --indicator-on-glow: rgba(255, 193, 7, 0.7);
      --button-start-bg: #28a745;
      --button-start-border: #218838;
      --button-stop-bg: #dc3545;
      --button-stop-border: #c82333;
      --button-neutral-bg: #007bff;
      --button-neutral-border: #0069d9;
      --switch-pos-bg: #007bff;
      --switch-pos-border: #0069d9;
      --switch-neg-bg: #dc3545;
      --switch-neg-border: #c82333;
      --switch-zero-bg: #ffffff;
      --switch-zero-border: #ced4da;
      --switch-zero-text: #343a40;
    }

    body.dark {
      --panel-bg: #2c2c2e;
      --background-color: #1c1c1e;
      --text-color: #f2f2f7;
      --text-color-light: #8e8e93;
      --border-color: #48484a;
      --indicator-off-bg: #3a3a3c;
      --indicator-off-border: #545458;
      --button-start-bg: #30d158;
      --button-start-border: #29b44c;
      --button-stop-bg: #ff453a;
      --button-stop-border: #f03d33;
      --button-neutral-bg: #0a84ff;
      --button-neutral-border: #007aff;
      --switch-pos-bg: #0a84ff;
      --switch-pos-border: #007aff;
      --switch-neg-bg: #ff453a;
      --switch-neg-border: #f03d33;
      --switch-zero-bg: #545458;
      --switch-zero-border: #636366;
      --switch-zero-text: #f2f2f7;
    }

    body {
      font-family: 'Inter', 'Arial', sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: background-color 0.3s, color 0.3s;
    }

    .top-controls {
      position: absolute;
      top: 20px;
      left: 20px;
      right: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 100;
    }

    .language-switcher, .theme-switcher {
      background: var(--panel-bg);
      padding: 5px 10px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .language-switcher {
      display: flex;
      align-items: center;
    }

    .language-switcher button, #theme-toggle {
      background: none;
      border: none;
      cursor: pointer;
      padding: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .language-switcher button {
      font-weight: 600;
      color: var(--text-color-light);
    }

    .language-switcher button.active {
      color: var(--button-neutral-bg);
      text-decoration: underline;
    }

    #theme-toggle svg {
      width: 22px;
      height: 22px;
      fill: var(--text-color-light);
    }

    h1 { font-size: 2.2rem; margin: 60px 0 2rem 0; text-align: center; color: var(--text-color); font-weight: 600; }

    .main-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 30px;
      width: 100%;
      max-width: 1400px;
    }

    .layout-container {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 30px;
      width: 100%;
    }

    @media (max-width: 1200px) {
      .layout-container {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background-color: var(--panel-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.08);
      transition: background-color 0.3s, border-color 0.3s;
    }

    .emulator-panel {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .io-and-status-panel {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .pult {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
    }
    .register-group {
      display: flex;
      flex-direction: column;
      gap: 20px;
      padding: 20px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background-color: var(--background-color);
    }
    .component { display: flex; flex-direction: column; align-items: center; }
    .component-label { font-weight: 600; font-size: 14px; margin-bottom: 12px; text-align: center; color: var(--text-color-light); }
    .indicator-row, .switch-row { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; align-items: center; }
    .trit { display: flex; flex-direction: column; align-items: center; gap: 5px; }

    .opcode-group {
      display: flex;
      gap: 8px;
      border: 2px solid var(--button-neutral-bg);
      border-radius: 8px;
      padding: 5px;
      background-color: rgba(0, 123, 255, 0.05);
    }

    .bulb { width: 18px; height: 18px; border-radius: 50%; background-color: var(--indicator-off-bg); border: 1px solid var(--indicator-off-border); box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); transition: all 0.2s; }
    .bulb.on { background-color: var(--indicator-on-bg); border-color: var(--indicator-on-border); box-shadow: 0 0 12px 2px var(--indicator-on-glow); }
    .trit-label { font-size: 10px; color: var(--text-color-light); }
    .switch { cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 5px; }
    .switch-body { width: 22px; height: 34px; background: #e9ecef; border: 1px solid #ced4da; border-radius: 4px; display: flex; align-items: center; justify-content: center; }
    .switch-knob { width: 18px; height: 18px; border-radius: 2px; position: relative; transition: all 0.2s ease-in-out; display: flex; align-items: center; justify-content: center; }
    .switch-value { color: #fff; font-size: 12px; font-family: 'Fira Code', monospace; font-weight: bold; user-select: none; -webkit-user-select: none; transition: color 0.2s ease-in-out; }
    .switch[data-value="1"] .switch-knob { transform: translateY(-8px); background-color: var(--switch-pos-bg); border: 1px solid var(--switch-pos-border); }
    .switch[data-value="0"] .switch-knob { transform: translateY(0); background-color: var(--switch-zero-bg); border: 1px solid var(--switch-zero-border); }
    .switch[data-value="-1"] .switch-knob { transform: translateY(8px); background-color: var(--switch-neg-bg); border: 1px solid var(--switch-neg-border); }
    .switch[data-value="0"] .switch-value { color: var(--switch-zero-text); }

    .control-panel { display: flex; flex-wrap: wrap; gap: 20px; padding-top: 20px; margin-top: 10px; border-top: 1px solid var(--border-color); justify-content: center; align-items: center; }
    .button { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 90px; height: 90px; border-radius: 50%; border: none; cursor: pointer; color: white; font-weight: bold; font-size: 14px; text-align: center; box-shadow: 0 4px 8px rgba(0,0,0,0.15), inset 0 2px 3px rgba(255,255,255,0.2); transition: all 0.1s ease-in-out; background: var(--button-neutral-bg); border-bottom: 4px solid var(--button-neutral-border); padding: 5px; }
    .button:active { transform: translateY(2px); box-shadow: 0 2px 4px rgba(0,0,0,0.15); border-bottom-width: 2px; }
    .button:disabled {
      background-color: #6c757d;
      border-bottom-color: #5a6268;
      cursor: not-allowed;
      opacity: 0.65;
    }
    .button .icon { width: 28px; height: 28px; margin-bottom: 5px; background-color: white; -webkit-mask-size: contain; mask-size: contain; -webkit-mask-repeat: no-repeat; mask-repeat: no-repeat; -webkit-mask-position: center; mask-position: center;}
    #btn-initial-start .icon { -webkit-mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="black"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM17 13l-5 5-5-5h3V9h4v4h3z"/></svg>'); mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="black"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM17 13l-5 5-5-5h3V9h4v4h3z"/></svg>');}
    #btn-start .icon { -webkit-mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="black"><path d="M8 5v14l11-7z"/></svg>'); mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="black"><path d="M8 5v14l11-7z"/></svg>');}
    #btn-step .icon { -webkit-mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="black"><path d="M14 12l-6-6v12l6-6zM16 6h2v12h-2z"/></svg>'); mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="black"><path d="M14 12l-6-6v12l6-6zM16 6h2v12h-2z"/></svg>');}
    #btn-stop .icon { -webkit-mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="black"><path d="M6 6h12v12H6z"/></svg>'); mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="black"><path d="M6 6h12v12H6z"/></svg>');}
    #btn-remote-cmd .icon { -webkit-mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="black"><path d="M15 7.5V2H9v5.5l3 3 3-3zM7.5 9H2v6h5.5l3-3-3-3zM9 16.5V22h6v-5.5l-3-3-3 3zM16.5 9l-3 3 3 3H22V9h-5.5z"/></svg>'); mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="black"><path d="M15 7.5V2H9v5.5l3 3 3-3zM7.5 9H2v6h5.5l3-3-3-3zM9 16.5V22h6v-5.5l-3-3-3 3zM16.5 9l-3 3 3 3H22V9h-5.5z"/></svg>');}

    .io-device { background: var(--panel-bg); border-radius: 8px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); display: flex; flex-direction: column; }
    .io-header {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    .io-header label {
      margin-bottom: 0;
    }
    #clear-printer-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 5px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s;
      margin-left: auto;
    }
    #clear-printer-btn:hover {
      background-color: var(--indicator-off-bg);
    }
    #clear-printer-btn svg {
      fill: var(--text-color-light);
    }
    .io-device label { font-weight: 600; }
    .io-device textarea, .io-device .output, .io-device button { width: 100%; box-sizing: border-box; border: 1px solid var(--border-color); border-radius: 6px; padding: 12px; font-family: 'Fira Code', monospace; font-size: 14px; }
    .io-device textarea:focus, .io-device button:focus { outline: 2px solid var(--button-neutral-bg); outline-offset: 2px; }
    .io-device .output { background-color: var(--indicator-off-bg); white-space: pre-wrap; overflow-y: auto; min-height: 150px; }
    .io-device button { margin-top: 10px; background-color: var(--button-neutral-bg); color: white; font-weight: bold; cursor: pointer; border: none; transition: background-color 0.2s; }
    .io-device button:hover { background-color: var(--button-neutral-border); }

    .info-section { width: 100%; max-width: 1200px; padding: 0; }
    .accordion-item { border-bottom: 1px solid var(--border-color); }
    .accordion-item:last-child { border-bottom: none; }
    .accordion-header { cursor: pointer; padding: 20px; display: flex; justify-content: space-between; align-items: center; font-size: 1.5rem; font-weight: 600; }
    .accordion-header::after { content: '‚ñº'; font-size: 1rem; transition: transform 0.3s; }
    .accordion-item.active .accordion-header::after { transform: rotate(180deg); }
    .accordion-content { display: none; padding: 0 20px 20px; line-height: 1.7; }
    .accordion-content pre { background-color: var(--indicator-off-bg); padding: 15px; border-radius: 6px; white-space: pre-wrap; word-break: break-all; font-family: 'Fira Code', monospace; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #dee2e6; padding: 12px; text-align: center; }
    th { background-color: var(--background-color); font-weight: 600; }

    footer { margin-top: 40px; text-align: center; font-size: 14px; color: #888; }
  </style>
</head>
<body>
<div class="top-controls">
  <div class="language-switcher">
    <button id="lang-en">EN</button> | <button id="lang-pt" class="active">PT</button>
  </div>
  <div class="theme-switcher">
    <button id="theme-toggle">
      <!-- SVG Icon will be inserted by JS -->
    </button>
  </div>
</div>


<div class="main-container">
  <h1 data-lang-key="mainTitle">Setun Emulador do Computador Tern√°rio</h1>

  <div class="layout-container">
    <div class="emulator-panel card" id="setun-emulator">
      <!-- A interface do emulador ser√° gerada aqui pelo JavaScript -->
    </div>

    <div class="io-and-status-panel">
      <div class="io-device card">
        <label for="ft1-input" data-lang-key="ft1Label">FT-1 (Entrada de Programa)</label>
        <textarea id="ft1-input" data-lang-key="ft1Placeholder" placeholder="Insira o programa tern√°rio aqui..."></textarea>
        <button id="ft1-load" data-lang-key="loadProgram">Ler Fita do Programa</button>
      </div>
      <div class="io-device card">
        <label for="ft2-input" data-lang-key="ft2Label">FT-2 (Entrada de Dados)</label>
        <textarea id="ft2-input" data-lang-key="ft2Placeholder" placeholder="Insira dados tern√°rios aqui..."></textarea>
        <button id="ft2-load" data-lang-key="loadData">Ler Fita de Dados</button>
      </div>
      <div class="io-device card">
        <div class="io-header">
          <label data-lang-key="printerLabel">Impressora EUM-46</label>
          <button id="clear-printer-btn" title="Limpar Sa√≠da">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
          </button>
        </div>
        <div id="printer-output" class="output"></div>
      </div>
    </div>
  </div>

  <div class="info-section card">
    <div class="accordion">
      <div class="accordion-item">
        <div class="accordion-header" data-lang-key="aboutTitle">Sobre o Setun</div>
        <div class="accordion-content">
          <p data-lang-key="aboutText">"Setun VS" √© um emulador do Setun MCVM, um computador tern√°rio sovi√©tico. Os principais elementos s√£o RAM, registradores, painel de controle e dispositivos perif√©ricos de entrada (FT-1, FT-2) e sa√≠da (EUM-46).</p>
        </div>
      </div>
      <div class="accordion-item">
        <div class="accordion-header" data-lang-key="componentsTitle">Componentes Principais</div>
        <div class="accordion-content">
          <div>
            <p><strong><span data-lang-key="registersLabel">Registradores:</span></strong> <span data-lang-key="registersDesc">Exibem o estado interno da m√°quina.</span></p>
            <ul>
              <li><strong><span data-lang-key="regSLabel">S (Resultado):</span></strong> <span data-lang-key="regSDesc">Registrador de 18 trits para resultados de opera√ß√µes.</span></li>
              <li><strong><span data-lang-key="regRLabel">R (Multiplicador):</span></strong> <span data-lang-key="regRDesc">Registrador de 18 trits usado em opera√ß√µes de multiplica√ß√£o.</span></li>
              <li><strong><span data-lang-key="regFLabel">F (Modifica√ß√£o):</span></strong> <span data-lang-key="regFDesc">Registrador de modifica√ß√£o de 5 trits.</span></li>
              <li><strong><span data-lang-key="regCLabel">C (Endere√ßo de Comando):</span></strong> <span data-lang-key="regCDesc">Registrador de endere√ßo de comando de 5 trits.</span></li>
              <li><strong><span data-lang-key="regKLabel">K (Comando):</span></strong> <span data-lang-key="regKDesc">Registrador de comando de 9 trits que armazena a instru√ß√£o atual.</span></li>
              <li><strong><span data-lang-key="regWLabel">œâ (w):</span></strong> <span data-lang-key="regWDesc">Determina a transfer√™ncia de controle em desvios condicionais.</span></li>
              <li><strong><span data-lang-key="regMBLabel">–ú–ë (MB):</span></strong> <span data-lang-key="regMBDesc">Endere√ßo da √∫ltima zona do tambor magn√©tico acessada.</span></li>
            </ul>
            <p><strong><span data-lang-key="switchesLabel">Interruptores (Entrada de Comando, Endere√ßo de Parada):</span></strong> <span data-lang-key="switchesDesc">Permitem a entrada manual de comandos e endere√ßos. Clique para alternar entre os estados (+1, 0, -1).</span></p>
            <p><strong><span data-lang-key="buttonsLabel">Bot√µes de Controle:</span></strong></p>
            <ul>
              <li><strong><span data-lang-key="btnLoadLabel">Carregar:</span></strong> <span data-lang-key="btnLoadDesc">Carrega dados da fita perfurada do dispositivo FT-1 para a RAM.</span></li>
              <li><strong><span data-lang-key="btnStartLabel">Iniciar:</span></strong> <span data-lang-key="btnStartDesc">Inicia a execu√ß√£o do programa.</span></li>
              <li><strong><span data-lang-key="btnStopLabel">Parar:</span></strong> <span data-lang-key="btnStopDesc">Encerra a execu√ß√£o do programa (n√£o implementado).</span></li>
              <li><strong><span data-lang-key="btnRemoteLabel">Comando Remoto:</span></strong> <span data-lang-key="btnRemoteDesc">Executa o comando inserido manualmente nos interruptores.</span></li>
            </ul>
            <p><strong><span data-lang-key="ioLabel">Dispositivos de E/S:</span></strong></p>
            <ul>
              <li><strong><span data-lang-key="ioFtLabel">FT-1 / FT-2:</span></strong> <span data-lang-key="ioFtDesc">Simulam leitores de fita perfurada para carregar programas e dados.</span></li>
              <li><strong><span data-lang-key="ioPrinterLabel">Impressora EUM-46:</span></strong> <span data-lang-key="ioPrinterDesc">Exibe a sa√≠da do programa (parcialmente implementada).</span></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="accordion-item">
        <div class="accordion-header" data-lang-key="instructionsTitle">Conjunto de Instru√ß√µes</div>
        <div class="accordion-content">
          <table>
            <thead>
            <tr>
              <th data-lang-key="tableTh1">C√≥digo (Tern√°rio)</th>
              <th data-lang-key="tableTh2">C√≥digo (Nove)</th>
              <th data-lang-key="tableTh3">Nome da Opera√ß√£o</th>
              <th data-lang-key="tableTh4">Descri√ß√£o</th>
            </tr>
            </thead>
            <tbody>
            <tr><td>+00</td><td>30</td><td data-lang-key="opName_30">Enviar para S</td><td>(A*) =&gt; (S)</td></tr>
            <tr><td>+0+</td><td>33</td><td data-lang-key="opName_33">Adi√ß√£o a S</td><td>(S)+(A*) =&gt; (S)</td></tr>
            <tr><td>+0-</td><td>3x</td><td data-lang-key="opName_3x">Subtra√ß√£o a S</td><td>(S)-(A*) =&gt; (S)</td></tr>
            <tr><td>++0</td><td>40</td><td data-lang-key="opName_40">Multiplica√ß√£o 0</td><td>(S)=&gt;(R); (A*)(R)=&gt;(S)</td></tr>
            <tr><td>+++</td><td>43</td><td data-lang-key="opName_43">Multiplica√ß√£o +</td><td>(S)+(A*)(R)=&gt;(S)</td></tr>
            <tr><td>++-</td><td>4x</td><td data-lang-key="opName_4x">Multiplica√ß√£o -</td><td>(A*)+(S)(R)=&gt;(S)</td></tr>
            <tr><td>+-0</td><td>20</td><td data-lang-key="opName_20">Multiplica√ß√£o bit a bit</td><td>(A*)[x](S)=&gt;(S)</td></tr>
            <tr><td>+-+</td><td>23</td><td data-lang-key="opName_23">Enviar para R</td><td>(A*)=&gt;(R)</td></tr>
            <tr><td>+--</td><td>2x</td><td data-lang-key="opName_2x">Parar</td><td>Parar; (A*)=&gt;(R)</td></tr>
            <tr><td>0+0</td><td>10</td><td data-lang-key="opName_10">Salto condicional 0</td><td>A*=>(C) quando w=0</td></tr>
            <tr><td>0++</td><td>13</td><td data-lang-key="opName_13">Salto condicional +</td><td>A*=>(C) quando w=+</td></tr>
            <tr><td>0+-</td><td>1x</td><td data-lang-key="opName_1x">Salto condicional -</td><td>A*=>(C) quando w=-</td></tr>
            <tr><td>000</td><td>00</td><td data-lang-key="opName_00">Salto incondicional</td><td>A*=>(C)</td></tr>
            <tr><td>-00</td><td>x0</td><td data-lang-key="opName_x0">Sa√≠da-entrada</td><td>Entrada para Fa*. Sa√≠da de Fa*</td></tr>
            <tr><td>-++</td><td>y3</td><td data-lang-key="opName_y3">Escrever de S</td><td>(S)=&gt;(A*)</td></tr>
            <tr><td>---</td><td>zhx</td><td data-lang-key="opName_zhx">Parar (N√£o utilizado)</td><td>Para a execu√ß√£o</td></tr>
            </tbody>
          </table>
          <p data-html-content="true" data-lang-key="instructionsNote"><i>Nota: Este √© um subconjunto simplificado para demonstra√ß√£o. A m√°quina Setun original tinha um conjunto de instru√ß√µes mais completo.</i></p>
        </div>
      </div>
      <div class="accordion-item">
        <div class="accordion-header" data-lang-key="usageTitle">Como Usar</div>
        <div class="accordion-content">
          <ol>
            <li><strong data-lang-key="usageLi1_1">Carregar Programa:</strong> <span data-lang-key="usageLi1_2">Insira o programa no campo FT-1 e clique em "Carregar Programa".</span></li>
            <li data-html-content="true" data-lang-key="usageLi2"><strong>Exemplo de Programa:</strong> Para carregar o n√∫mero 10 e depois adicionar -4, resultando em 6.
              <pre>
// Carrega 10 (...+0+) no Somador S
+00 000000000000000+0+
// Adiciona -4 (...0-+) ao Somador S
+0+ 0000000000000000-+
// Para o programa
--- 000000000000000000
</pre>
            </li>
            <li data-html-content="true" data-lang-key="usageLi3"><strong data-lang-key="usageLi3_1">Carregar para a RAM:</strong> <span data-lang-key="usageLi3_2">Clique no bot√£o <strong>'Carregar'</strong>. Isso transfere os dados da fita para a mem√≥ria.</span></li>
            <li data-html-content="true" data-lang-key="usageLi4"><strong data-lang-key="usageLi4_1">Executar:</strong> <span data-lang-key="usageLi4_2">Clique no bot√£o <strong>'Iniciar'</strong> para come√ßar a execu√ß√£o.</span></li>
            <li><strong><span data-lang-key="usageLi5_1">Observar:</span></strong> <span data-lang-key="usageLi5_2">As luzes do registrador 'S' mostrar√£o o valor 6 (...+--).</span></li>
          </ol>
        </div>
      </div>
      <div class="accordion-item">
        <div class="accordion-header" data-lang-key="readingTitle">Como Ler os Resultados</div>
        <div class="accordion-content" data-lang-key="readingContent" data-html-content="true">
        </div>
      </div>
    </div>
  </div>

  <footer>
    <p>License MIT Robson Cassiano</p>
    <p>Vida Longa e Pr√≥spera üññüèª</p>
  </footer>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // --- Theme Switcher Logic ---
    const themeToggleBtn = document.getElementById('theme-toggle');
    const sunIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.64 5.64c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41l1.06 1.06c.39.39 1.02.39 1.41 0s.39-1.02 0-1.41L5.64 5.64zm12.72 12.72c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41l1.06 1.06c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41l-1.06-1.06zM5.64 18.36c.39-.39.39-1.02 0-1.41-.39-.39-1.02-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.02 0 1.41s1.02.39 1.41 0l1.06-1.06zm12.72-12.72c.39-.39.39-1.02 0-1.41-.39-.39-1.02-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.02 0 1.41s1.02.39 1.41 0l1.06-1.06z"/></svg>`;
    const moonIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.82.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/></svg>`;

    const applyTheme = (theme) => {
      if (theme === 'dark') {
        document.body.classList.add('dark');
        themeToggleBtn.innerHTML = sunIcon;
        localStorage.setItem('theme', 'dark');
      } else {
        document.body.classList.remove('dark');
        themeToggleBtn.innerHTML = moonIcon;
        localStorage.setItem('theme', 'light');
      }
    };

    themeToggleBtn.addEventListener('click', () => {
      const newTheme = document.body.classList.contains('dark') ? 'light' : 'dark';
      applyTheme(newTheme);
    });

    // --- End Theme Logic ---


    const translations = {
      en: {
        mainTitle: "Setun Ternary Computer Emulator",
        aboutTitle: "About Setun",
        componentsTitle: "Main Components",
        instructionsTitle: "Instruction Set",
        usageTitle: "How to Use",
        readingTitle: "How to Read the Results",
        ft1Label: "FT-1 (Program Input)",
        ft2Label: "FT-2 (Data Input)",
        printerLabel: "EUM-46 Printer",
        ft1Placeholder: "Enter ternary program here...",
        ft2Placeholder: "Enter ternary data here...",
        regS: "Adder",
        regR: "Multiplicand",
        regK: "Command",
        regC: "Command Counter",
        regF: "Modifier",
        regW: "œâ",
        regMB: "MB Zone",
        switchNK: "Command Input",
        switchAO: "Stop Address",
        loadProgram: "Read Program Tape",
        loadData: "Read Data Tape",
        initialStart: "Load",
        start: "Start",
        step: "Step",
        stop: "Stop",
        remoteCmd: "Remote Command",
        aboutText: `"Setun VS" is an emulator of the Setun MCVM (a Soviet ternary computer). The main elements are RAM, registers, a control panel, and peripheral input (FT-1, FT-2) and output (EUM-46) devices.`,
        registersLabel: "Registers:",
        registersDesc: "Display the internal state of the machine.",
        regSLabel: "S (Result):",
        regSDesc: "18-trit register for operation results.",
        regRLabel: "R (Multiplier):",
        regRDesc: "18-trit register used in multiplication operations.",
        regFLabel: "F (Modification):",
        regFDesc: "5-trit modification register.",
        regCLabel: "C (Command Address):",
        regCDesc: "5-trit command address register.",
        regKLabel: "K (Command):",
        regKDesc: "9-trit command register that stores the current instruction.",
        regWLabel: "œâ (w):",
        regWDesc: "Determines control transfer in conditional branches.",
        regMBLabel: "–ú–ë (MB):",
        regMBDesc: "Address of the last accessed magnetic drum zone.",
        switchesLabel: "Switches (Command Input, Stop Address):",
        switchesDesc: "Allow manual entry of commands and addresses. Click to cycle through states (+1, 0, -1).",
        buttonsLabel: "Control Buttons:",
        btnLoadLabel: "Load:",
        btnLoadDesc: "Loads data from the FT-1 paper tape device into RAM.",
        btnStartLabel: "Start:",
        btnStartDesc: "Starts program execution.",
        btnStopLabel: "Stop:",
        btnStopDesc: "Halts program execution (not implemented).",
        btnRemoteLabel: "Remote Command:",
        btnRemoteDesc: "Executes the command entered manually on the switches.",
        ioLabel: "I/O Devices:",
        ioFtLabel: "FT-1 / FT-2:",
        ioFtDesc: "Simulate paper tape readers to load programs and data.",
        ioPrinterLabel: "EUM-46 Printer:",
        ioPrinterDesc: "Displays program output (partially implemented).",
        tableTh1: "Code (Ternary)",
        tableTh2: "Code (Novech)",
        tableTh3: "Operation Name",
        tableTh4: "Description",
        opName_30: "Send to S",
        opName_33: "Addition to S",
        opName_3x: "Subtraction from S",
        opName_40: "Multiplication 0",
        opName_43: "Multiplication +",
        opName_4x: "Multiplication -",
        opName_20: "Bitwise Multiplication",
        opName_23: "Send to R",
        opName_2x: "Stop",
        opName_10: "Conditional jump 0",
        opName_13: "Conditional jump +",
        opName_1x: "Conditional jump -",
        opName_00: "Unconditional jump",
        opName_x0: "Input-output",
        opName_y3: "Write from S",
        opName_zhx: "Halt (Unused)",
        instructionsNote: "<i>Note: This is a simplified subset for demonstration. The original Setun machine had a more complete instruction set.</i>",
        usageLi1_1: "Load a Program:",
        usageLi1_2: "Enter the program into the FT-1 field and click 'Load Program'.",
        usageLi2: `<strong>Example Program:</strong> To load the number 10 and then add -4, resulting in 6.
<pre>
// Load 10 (...+0+) to address 2
000 000000000000000000
// Add -4 (...---) to address 3
000 000000000000000000
+00 000000000000000+0+
+0+ 000000000000000---
--- 000000000000000000
</pre>`,
        usageLi3: "",
        usageLi3_1: "Load to RAM:",
        usageLi3_2: "Click the <strong>'Load'</strong> button. This transfers data from the tape to memory.",
        usageLi4: "",
        usageLi4_1: "Execute:",
        usageLi4_2: "Click the <strong>'Start'</strong> button to begin execution.",
        usageLi5_1: "Observe:",
        usageLi5_2: "The lights of the 'S' register should show the ternary value for 6 (`...+--`).",
        readingContent: `<p>The key to reading the panel is to understand the <strong>balanced ternary system</strong>. Each pair of lights (bulbs) represents a "trit," which can have three values:</p><ul><li><strong>+1:</strong> The top light is on.</li><li><strong>0:</strong> Both lights are off.</li><li><strong>-1:</strong> The bottom light is on.</li></ul><p>To convert the value of a register to decimal, you must multiply the value of each trit (1, 0, or -1) by the power of 3 corresponding to its position, starting with 3<sup>0</sup> on the far right.</p><p><strong>Practical Example: Reading the number 10 in the Adder (S)</strong></p><p>Imagine the top lights at positions <strong>16</strong> and <strong>18</strong> are on. The reading would be:</p><ul><li>... (other trits are 0) ...</li><li><strong>Position 16 (+1):</strong> 1 √ó 3<sup>2</sup> = 9</li><li><strong>Position 17 (0):</strong> 0 √ó 3<sup>1</sup> = 0</li><li><strong>Position 18 (+1):</strong> 1 √ó 3<sup>0</sup> = 1</li></ul><p><strong>Total:</strong> 9 + 0 + 1 = 10.</p>`,
        logTape1Ready: "Program tape ready. Use 'Load' to load into RAM.",
        logTape2Ready: "Data tape ready.",
        logInitialStart: "Load: Loading program from FT-1 to RAM...",
        logProgramLoaded: "Program loaded. {count} instructions.",
        logRun: "Starting program execution.",
        logStop: "Execution halted by user.",
        logHalted: "Program halted. Press 'Load' to reload.",
        logEnd: "End of program or halt.",
        logStep: "PC {pc}: Transferred value {value} to S.",
        logStepExec: "Executing step at PC {pc}...",
        logAdd: "PC {pc}: Added value {value} to S. New value: {newValue}",
        logSub: "PC {pc}: Subtracted value {value} from S. New value: {newValue}",
        logStore: "PC {pc}: Stored value from S ({value}) to address {address}",
        logJump: "PC {pc}: Jump to address {address}",
        logHaltInstruction: "PC {pc}: Halt instruction found. Final value in S: {value}",
        logUnknown: "PC {pc}: Unknown instruction {opcode}",
        logRemote: "Executing remote command...",
        logRemoteExec: "Remote command {opcode} with operand {operand} executed."
      },
      pt: {
        mainTitle: "Setun Emulador do Computador Tern√°rio",
        aboutTitle: "Sobre o Setun",
        componentsTitle: "Componentes Principais",
        instructionsTitle: "Conjunto de Instru√ß√µes",
        usageTitle: "Como Usar",
        readingTitle: "Como Ler os Resultados",
        ft1Label: "FT-1 (Entrada de Programa)",
        ft2Label: "FT-2 (Entrada de Dados)",
        printerLabel: "Impressora EUM-46",
        ft1Placeholder: "Insira o programa tern√°rio aqui...",
        ft2Placeholder: "Insira dados tern√°rios aqui...",
        regS: "Somador",
        regR: "Multiplicando",
        regK: "Comando",
        regC: "Contador de Comandos",
        regF: "Modificador",
        regW: "œâ",
        regMB: "Zona MB",
        switchNK: "Entrada de Comando",
        switchAO: "Endere√ßo de Parada",
        loadProgram: "Ler Fita do Programa",
        loadData: "Ler Fita de Dados",
        initialStart: "Carregar",
        start: "Iniciar",
        step: "Passo",
        stop: "Parar",
        remoteCmd: "Comando Remoto",
        aboutText: `"Setun VS" √© um emulador do Setun MCVM, um computador tern√°rio sovi√©tico. Os principais elementos s√£o RAM, registradores, painel de controle e dispositivos perif√©ricos de entrada (FT-1, FT-2) e sa√≠da (EUM-46).`,
        registersLabel: "Registradores:",
        registersDesc: "Exibem o estado interno da m√°quina.",
        regSLabel: "S (Resultado):",
        regSDesc: "Registrador de 18 trits para resultados de opera√ß√µes.",
        regRLabel: "R (Multiplicador):",
        regRDesc: "Registrador de 18 trits usado em opera√ß√µes de multiplica√ß√£o.",
        regFLabel: "F (Modifica√ß√£o):",
        regFDesc: "Registrador de modifica√ß√£o de 5 trits.",
        regCLabel: "C (Endere√ßo de Comando):",
        regCDesc: "Registrador de endere√ßo de comando de 5 trits.",
        regKLabel: "K (Comando):",
        regKDesc: "Registrador de comando de 9 trits que armazena a instru√ß√£o atual.",
        regWLabel: "œâ (w):",
        regWDesc: "Determina a transfer√™ncia de controle em desvios condicionais.",
        regMBLabel: "–ú–ë (MB):",
        regMBDesc: "Endere√ßo da √∫ltima zona do tambor magn√©tico acessada.",
        switchesLabel: "Interruptores (Entrada de Comando, Endere√ßo de Parada):",
        switchesDesc: "Permitem a entrada manual de comandos e endere√ßos. Clique para alternar entre os estados (+1, 0, -1).",
        buttonsLabel: "Bot√µes de Controle:",
        btnLoadLabel: "Carregar:",
        btnLoadDesc: "Carrega dados da fita perfurada do dispositivo FT-1 para a RAM.",
        btnStartLabel: "Iniciar:",
        btnStartDesc: "Inicia a execu√ß√£o do programa.",
        btnStopLabel: "Parar:",
        btnStopDesc: "Encerra a execu√ß√£o do programa (n√£o implementado).",
        btnRemoteLabel: "Comando Remoto:",
        btnRemoteDesc: "Executa o comando inserido manualmente nos interruptores.",
        ioLabel: "Dispositivos de E/S:",
        ioFtLabel: "FT-1 / FT-2:",
        ioFtDesc: "Simulam leitores de fita perfurada para carregar programas e dados.",
        ioPrinterLabel: "Impressora EUM-46:",
        ioPrinterDesc: "Exibe a sa√≠da do programa (parcialmente implementada).",
        tableTh1: "C√≥digo (Tern√°rio)",
        tableTh2: "C√≥digo (Nove)",
        tableTh3: "Nome da Opera√ß√£o",
        tableTh4: "Descri√ß√£o",
        opName_30: "Enviar para S",
        opName_33: "Adi√ß√£o a S",
        opName_3x: "Subtra√ß√£o a S",
        opName_40: "Multiplica√ß√£o 0",
        opName_43: "Multiplica√ß√£o +",
        opName_4x: "Multiplica√ß√£o -",
        opName_20: "Multiplica√ß√£o bit a bit",
        opName_23: "Enviar para R",
        opName_2x: "Parar",
        opName_10: "Salto condicional 0",
        opName_13: "Salto condicional +",
        opName_1x: "Salto condicional -",
        opName_00: "Salto incondicional",
        opName_x0: "Sa√≠da-entrada",
        opName_y3: "Escrever de S",
        opName_zhx: "Parar (N√£o utilizado)",
        instructionsNote: "<i>Nota: Este √© um subconjunto simplificado para demonstra√ß√£o. A m√°quina Setun original tinha um conjunto de instru√ß√µes mais completo.</i>",
        usageLi1_1: "Carregar Programa:",
        usageLi1_2: "Insira o programa no campo FT-1 e clique em 'Carregar Programa'.",
        usageLi2: `<strong>Exemplo de Programa:</strong> Para carregar o n√∫mero 10 e depois adicionar -4, resultando em 6.
<pre>
// Carrega 10 (...+0+) no Somador S
+00 000000000000000+0+
// Adiciona -4 (...0-+) ao Somador S
+0+ 0000000000000000-+
// Para o programa
--- 000000000000000000
</pre>`,
        usageLi3_1: "Carregar para a RAM:",
        usageLi3_2: "Clique no bot√£o <strong>'Carregar'</strong>. Isso transfere os dados da fita para a mem√≥ria.",
        usageLi4_1: "Executar:",
        usageLi4_2: "Clique no bot√£o <strong>'Iniciar'</strong> para come√ßar a execu√ß√£o.",
        usageLi5_1: "Observar:",
        usageLi5_2: "As luzes do registrador 'S' mostrar√£o o valor 6 (...+--).",
        readingContent: `<p>A chave para ler o painel √© entender o <strong>sistema tern√°rio balanceado</strong>. Cada par de luzes (bulbs) representa um "trit", que pode ter tr√™s valores:</p><ul><li><strong>+1:</strong> A luz de cima est√° acesa.</li><li><strong>0:</strong> Ambas as luzes est√£o apagadas.</li><li><strong>-1:</strong> A luz de baixo est√° acesa.</li></ul><p>Para converter o valor de um registrador para decimal, voc√™ deve multiplicar o valor de cada trit (1, 0 ou -1) pela pot√™ncia de 3 correspondente √† sua posi√ß√£o, come√ßando com 3<sup>0</sup> na extrema direita.</p><p><strong>Exemplo pr√°tico: Lendo o n√∫mero 10 no Somador (S)</strong></p><p>Imagine que as luzes superiores nas posi√ß√µes <strong>16</strong> e <strong>18</strong> est√£o acesas. A leitura seria:</p><ul><li>... (outros trits s√£o 0) ...</li><li><strong>Posi√ß√£o 16 (+1):</strong> 1 √ó 3<sup>2</sup> = 9</li><li><strong>Posi√ß√£o 17 (0):</strong> 0 √ó 3<sup>1</sup> = 0</li><li><strong>Posi√ß√£o 18 (+1):</strong> 1 √ó 3<sup>0</sup> = 1</li></ul><p><strong>Total:</strong> 9 + 0 + 1 = 10.</p>`,
        logTape1Ready: "Fita de programa pronta. Use 'Carregar' para carregar na RAM.",
        logTape2Ready: "Fita de dados pronta.",
        logInitialStart: "Carregar: Carregando programa da FT-1 para a RAM...",
        logProgramLoaded: "Programa carregado. {count} instru√ß√µes.",
        logRun: "Iniciando execu√ß√£o do programa.",
        logStop: "Execu√ß√£o interrompida pelo usu√°rio.",
        logHalted: "Programa parado. Pressione 'Carregar' para recarregar.",
        logEnd: "Fim do programa ou halt.",
        logStep: "PC {pc}: Transferido valor {value} para S.",
        logStepExec: "Executando passo no PC {pc}...",
        logAdd: "PC {pc}: Adicionado valor {value} a S. Novo valor: {newValue}",
        logSub: "PC {pc}: Subtra√≠do valor {value} de S. Novo valor: {newValue}",
        logStore: "PC {pc}: Armazenado valor de S ({value}) no endere√ßo {address}",
        logJump: "PC {pc}: Salto para o endere√ßo {address}",
        logHaltInstruction: "PC {pc}: Instru√ß√£o de parada encontrada. Valor final em S: {value}",
        logUnknown: "PC {pc}: Instru√ß√£o desconhecida {opcode}",
        logRemote: "Executando comando remoto...",
        logRemoteExec: "Comando remoto {opcode} com operando {operand} executado."
      }
    };

    const setun = {
      registers: { S: Array(18).fill(0), R: Array(18).fill(0), F: Array(5).fill(0), C: Array(5).fill(0), K: Array(9).fill(0), W: [0], MB: Array(4).fill(0) },
      ram: Array(243 * 2).fill(0), // 243 addresses, each with opcode and operand
      pc: 0,
      running: false,
      halted: false,
      registerSizes: { S: 18, R: 18, F: 5, C: 5, K: 9, W: 1, MB: 4 },
      switchSetSizes: { 'nk': 18, 'ao': 5 },
      manualSwitches: { nk: Array(18).fill(0), ao: Array(5).fill(0) },
      currentLang: 'pt',
      translations: translations,

      init() {
        this.buildUI();
        this.attachEventListeners();
        this.setLanguage(this.currentLang); // This will re-build and re-attach
        this.updateUI();
        this.initAccordion();
        this.updateButtonStates();

        const savedTheme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const initialTheme = savedTheme || (prefersDark ? 'dark' : 'light');
        applyTheme(initialTheme);
      },

      initAccordion() {
        const accordionItems = document.querySelectorAll('.accordion-item');
        accordionItems.forEach(item => {
          const header = item.querySelector('.accordion-header');
          const content = item.querySelector('.accordion-content');
          header.addEventListener('click', () => {
            accordionItems.forEach(otherItem => {
              if (otherItem !== item && otherItem.classList.contains('active')) {
                otherItem.classList.remove('active');
                otherItem.querySelector('.accordion-content').style.display = 'none';
              }
            });
            item.classList.toggle('active');
            content.style.display = item.classList.contains('active') ? 'block' : 'none';
          });
        });
      },

      setLanguage(lang) {
        this.currentLang = lang;
        document.documentElement.lang = lang === 'pt' ? 'pt-BR' : lang;

        document.querySelectorAll('[data-lang-key]').forEach(el => {
          const key = el.dataset.langKey;
          const translation = this.translations[lang][key];
          if (translation) {
            if (el.tagName === 'TEXTAREA' || el.tagName === 'INPUT') {
              el.placeholder = translation;
            } else if (el.dataset.htmlContent === 'true') {
              el.innerHTML = translation;
            } else {
              el.textContent = translation;
            }
          }
        });

        document.getElementById('lang-pt').classList.toggle('active', lang === 'pt');
        document.getElementById('lang-en').classList.toggle('active', lang === 'en');

        // Re-build UI to update labels inside dynamic components
        this.buildUI();
        this.attachEventListeners(); // Re-attach listeners after rebuilding
        this.updateUI(); // Refresh UI state
      },

      buildUI() {
        const container = document.getElementById('setun-emulator');

        const createIndicatorComponent = (name, langKey, size) => {
          let indicatorsHTML = '';

          const createTritHTML = (tritIndex) => {
            return `<div class="trit" id="${name.toLowerCase()}-trit-${tritIndex}">
                            <div class="bulb bulb-pos"></div>
                            <div class="bulb bulb-neg"></div>
                            <div class="trit-label">${tritIndex + 1}</div>
                        </div>`;
          };

          if (name === 'K') {
            let opcodeTrits = '';
            for (let i = 0; i < 3; i++) {
              opcodeTrits += createTritHTML(i);
            }

            let operandTrits = '';
            for (let i = 3; i < size; i++) {
              operandTrits += createTritHTML(i);
            }
            indicatorsHTML = `<div class="opcode-group">${opcodeTrits}</div>${operandTrits}`;
          } else {
            for (let i = 0; i < size; i++) {
              indicatorsHTML += createTritHTML(i);
            }
          }

          const labelText = this.translations[this.currentLang][langKey] || langKey;
          const displayName = (name === 'W' || name === 'MB') ? '' : ` (${name})`;
          return `<div class="component indicator-component" id="indicator-${name.toLowerCase()}">
                                <div class="component-label" data-lang-key="${langKey}">${labelText}${displayName}</div>
                                <div class="indicator-row">${indicatorsHTML}</div>
                            </div>`;
        };

        const createSwitchComponent = (name, langKey, size) => {
          let switches = '';
          for (let i = 0; i < size; i++) {
            switches += `<div class="switch" data-value="${this.manualSwitches[name.toLowerCase()][i]}" data-direction="up" id="${name.toLowerCase()}-switch-${i}">
                                        <div class="switch-body">
                                            <div class="switch-knob">
                                                <span class="switch-value">${this.manualSwitches[name.toLowerCase()][i]}</span>
                                            </div>
                                        </div>
                                        <div class="trit-label">${i + 1}</div>
                                    </div>`;
          }
          return `<div class="component switch-component" id="switch-${name.toLowerCase()}">
                                <div class="component-label" data-lang-key="${langKey}">${this.translations[this.currentLang][langKey]}</div>
                                <div class="switch-row">${switches}</div>
                            </div>`;
        };

        const createButton = (id, langKey) => {
          const label = this.translations[this.currentLang][langKey];
          return `<button class="button" id="${id}">
                                <div class="icon"></div>
                                <span data-lang-key="${langKey}">${label}</span>
                            </button>`;
        };

        let html = `
                    <div class="pult">
                        <div class="register-group">
                            ${createIndicatorComponent('S', 'regS', this.registerSizes.S)}
                            ${createIndicatorComponent('R', 'regR', this.registerSizes.R)}
                        </div>
                        <div class="register-group">
                            ${createIndicatorComponent('K', 'regK', this.registerSizes.K)}
                            ${createIndicatorComponent('C', 'regC', this.registerSizes.C)}
                            ${createIndicatorComponent('F', 'regF', this.registerSizes.F)}
                            <div style="display: flex; gap: 20px; justify-content: center;">
                                ${createIndicatorComponent('W', 'regW', 1)}
                                ${createIndicatorComponent('MB', 'regMB', this.registerSizes.MB)}
                            </div>
                        </div>
                        <div class="register-group">
                            ${createSwitchComponent('nk', 'switchNK', this.switchSetSizes.nk)}
                            ${createSwitchComponent('ao', 'switchAO', this.switchSetSizes.ao)}
                        </div>
                    </div>
                    <div class="control-panel">
                        ${createButton('btn-initial-start', 'initialStart')}
                        ${createButton('btn-start', 'start')}
                        ${createButton('btn-step', 'step')}
                        ${createButton('btn-stop', 'stop')}
                        ${createButton('btn-remote-cmd', 'remoteCmd')}
                    </div>
                `;

        container.innerHTML = html;

        document.getElementById('btn-start').style.backgroundColor = 'var(--button-start-bg)';
        document.getElementById('btn-stop').style.backgroundColor = 'var(--button-stop-bg)';
      },

      attachEventListeners() {
        const container = document.getElementById('setun-emulator');

        document.getElementById('lang-en').addEventListener('click', () => this.setLanguage('en'));
        document.getElementById('lang-pt').addEventListener('click', () => this.setLanguage('pt'));

        container.querySelector('#btn-initial-start').addEventListener('click', () => this.initialStart());
        container.querySelector('#btn-start').addEventListener('click', () => this.run());
        container.querySelector('#btn-step').addEventListener('click', () => {
          if (!this.running && !this.halted) {
            this.step();
          }
        });
        container.querySelector('#btn-stop').addEventListener('click', () => this.stop());
        container.querySelector('#btn-remote-cmd').addEventListener('click', () => this.executeRemoteCommand());

        document.getElementById('ft1-load').addEventListener('click', () => this.logMessage("logTape1Ready"));
        document.getElementById('ft2-load').addEventListener('click', () => this.logMessage("logTape2Ready"));

        document.getElementById('clear-printer-btn').addEventListener('click', () => {
          document.getElementById('printer-output').textContent = '';
        });

        Object.keys(this.switchSetSizes).forEach(setName => {
          for (let i = 0; i < this.switchSetSizes[setName]; i++) {
            const sw = container.querySelector(`#${setName}-switch-${i}`);
            sw.addEventListener('click', () => {
              let value = parseInt(sw.dataset.value);
              let direction = sw.dataset.direction;

              if (value === 0 && direction === 'up') {
                value = 1;
              } else if (value === 1) {
                value = 0;
                direction = 'down';
              } else if (value === 0 && direction === 'down') {
                value = -1;
              } else if (value === -1) {
                value = 0;
                direction = 'up';
              }

              this.manualSwitches[setName][i] = value;
              sw.dataset.value = value;
              sw.dataset.direction = direction;
              sw.querySelector('.switch-value').textContent = value;
            });
          }
        });
      },

      updateButtonStates() {
        const startBtn = document.getElementById('btn-start');
        const stepBtn = document.getElementById('btn-step');
        const stopBtn = document.getElementById('btn-stop');

        if (!startBtn || !stepBtn || !stopBtn) return;

        if (this.running) {
          startBtn.disabled = true;
          stepBtn.disabled = true;
          stopBtn.disabled = false;
        } else if (this.halted) {
          startBtn.disabled = true;
          stepBtn.disabled = true;
          stopBtn.disabled = true;
        } else { // Idle, ready to start
          startBtn.disabled = false;
          stepBtn.disabled = false;
          stopBtn.disabled = true;
        }
      },

      updateUI() {
        Object.keys(this.registers).forEach(reg => {
          const size = this.registerSizes[reg];
          for (let i = 0; i < size; i++) {
            const tritEl = document.getElementById(`${reg.toLowerCase()}-trit-${i}`);
            if (tritEl) {
              const val = this.registers[reg][i] || 0;
              const bulbPos = tritEl.querySelector('.bulb-pos');
              const bulbNeg = tritEl.querySelector('.bulb-neg');
              bulbPos.classList.toggle('on', val === 1);
              bulbNeg.classList.toggle('on', val === -1);
            }
          }
        });
      },

      logMessage(key, params = {}) {
        const output = document.getElementById('printer-output');
        const time = new Date().toLocaleTimeString();
        let msg = this.translations[this.currentLang][key] || key;

        for (const p in params) {
          msg = msg.replace(`{${p}}`, params[p]);
        }

        output.textContent += `[${time}] ${msg}\n`;
        output.scrollTop = output.scrollHeight;
      },

      parseTritString(str) {
        return str.toUpperCase().split('').map(char => {
          if (char === '1' || char === '+') return 1;
          if (char === 'T' || char === '-') return -1;
          return 0;
        });
      },

      initialStart() {
        this.logMessage("logInitialStart");
        const programText = document.getElementById('ft1-input').value;
        const lines = programText.split(/[\n\r]+/).filter(line => line.trim() !== '' && !line.trim().startsWith('//'));

        this.ram.fill(0);
        let memAddress = 0;
        lines.forEach(line => {
          const parts = line.trim().split(/\s+/);
          if (parts.length >= 1) { // Can be just an opcode or data
            const instruction = this.parseTritString(parts[0]);
            const data = parts.length > 1 ? this.parseTritString(parts[1]) : Array(18).fill(0);

            if ((memAddress * 2) < this.ram.length) {
              this.ram[memAddress * 2] = { type: 'opcode', value: instruction };
              this.ram[memAddress * 2 + 1] = { type: 'operand', value: data };
              memAddress++;
            }
          }
        });

        this.pc = 0;
        this.halted = false;
        this.running = false;
        this.registers.S.fill(0);
        this.registers.R.fill(0);
        this.registers.C.fill(0);
        this.registers.K.fill(0);

        this.logMessage("logProgramLoaded", {count: lines.length});
        this.updateUI();
        this.updateButtonStates();
      },

      run() {
        if (this.halted || this.running) return;
        this.running = true;
        this.logMessage("logRun");
        this.updateButtonStates();

        const executeCycle = () => {
          if (!this.running || this.halted) {
            this.running = false; // Ensure running is false if loop stops
            this.updateButtonStates();
            return;
          }
          this.step();
          setTimeout(executeCycle, 250);
        };
        executeCycle();
      },

      stop() {
        this.running = false;
        this.halted = true;
        this.logMessage("logStop");
        this.updateButtonStates();
      },

      getEffectiveAddress(operand) {
        const addressTrits = operand.slice(-5); // Get the last 5 trits for the address
        const baseAddress = this.tritArrayToNumber(addressTrits);
        const modifier = this.tritArrayToNumber(this.registers.F);
        return (baseAddress + modifier);
      },

      step() {
        if (this.halted) return;

        const ramIndex = this.pc * 2;

        if (ramIndex >= this.ram.length || !this.ram[ramIndex]) {
          this.running = false;
          this.halted = true;
          if (!this.ram[ramIndex]) this.logMessage("logEnd");
          this.updateUI();
          this.updateButtonStates();
          return;
        }

        this.logMessage("logStepExec", { pc: this.pc });
        this.registers.C = this.numberToTritArray(this.pc, 5);

        const instruction = this.ram[ramIndex];
        const operandEntry = this.ram[ramIndex + 1];

        if (!instruction || instruction.type !== 'opcode' || !operandEntry) {
          this.pc += 1;
          this.updateUI();
          this.updateButtonStates();
          return;
        }

        const opcodeStr = instruction.value.map(t => ({ '1': '+', '0': '0', '-1': '-' })[t]).join('');

        this.registers.K.fill(0);
        instruction.value.forEach((trit, i) => this.registers.K[i] = trit);

        let pcModified = false;

        let valueToOperateOn = operandEntry.value;
        let effectiveAddress;

        switch(opcodeStr) {
          case '+00':
            this.registers.S = valueToOperateOn.slice();
            this.logMessage("logStep", {pc: this.pc, value: this.tritArrayToNumber(valueToOperateOn)});
            break;
          case '+0+':
            this.registers.S = this.ternaryAdd(this.registers.S, valueToOperateOn);
            this.logMessage("logAdd", {pc: this.pc, value: this.tritArrayToNumber(valueToOperateOn), newValue: this.tritArrayToNumber(this.registers.S)});
            break;
          case '+0-':
            const negatedVal = valueToOperateOn.map(t => -t);
            this.registers.S = this.ternaryAdd(this.registers.S, negatedVal);
            this.logMessage("logSub", {pc: this.pc, value: this.tritArrayToNumber(valueToOperateOn), newValue: this.tritArrayToNumber(this.registers.S)});
            break;
          case '-++':
            effectiveAddress = this.getEffectiveAddress(operandEntry.value);
            if (this.ram[effectiveAddress * 2 + 1]) {
              this.ram[effectiveAddress * 2 + 1].value = this.registers.S.slice();
              this.logMessage("logStore", {pc: this.pc, value: this.tritArrayToNumber(this.registers.S), address: effectiveAddress});
            }
            break;
          case '000':
            effectiveAddress = this.getEffectiveAddress(operandEntry.value);
            this.pc = effectiveAddress;
            pcModified = true;
            this.logMessage("logJump", {pc: this.pc, address: effectiveAddress});
            break;
          case '0++':
            effectiveAddress = this.getEffectiveAddress(operandEntry.value);
            if(this.registers.W[0] === 1) {
              this.pc = effectiveAddress;
              pcModified = true;
              this.logMessage("logJump", {pc: this.pc, address: effectiveAddress});
            }
            break;
          case '0+-':
            effectiveAddress = this.getEffectiveAddress(operandEntry.value);
            if(this.registers.W[0] === -1) {
              this.pc = effectiveAddress;
              pcModified = true;
              this.logMessage("logJump", {pc: this.pc, address: effectiveAddress});
            }
            break;
          case '0+0':
            effectiveAddress = this.getEffectiveAddress(operandEntry.value);
            if(this.registers.W[0] === 0) {
              this.pc = effectiveAddress;
              pcModified = true;
              this.logMessage("logJump", {pc: this.pc, address: effectiveAddress});
            }
            break;
          case '+--':
          case '---':
            this.halted = true;
            this.running = false;
            this.logMessage("logHaltInstruction", {pc: this.pc, value: this.tritArrayToNumber(this.registers.S)});
            break;
          default:
            this.logMessage("logUnknown", {pc: this.pc, opcode: opcodeStr});
            this.halted = true;
            this.running = false;
            break;
        }

        const s_val = this.tritArrayToNumber(this.registers.S);
        this.registers.W[0] = s_val > 0 ? 1 : (s_val < 0 ? -1 : 0);

        if (!this.halted && !pcModified) {
          this.pc += 1;
        }

        this.updateUI();
        this.updateButtonStates();
      },

      ternaryAdd(arrA, arrB) {
        let carry = 0;
        const result = Array(18).fill(0);
        for (let i = 17; i >= 0; i--) {
          const sum = (arrA[i] || 0) + (arrB[i] || 0) + carry;
          switch (sum) {
            case 3: result[i] = 0; carry = 1; break;
            case 2: result[i] = -1; carry = 1; break;
            case 1: result[i] = 1; carry = 0; break;
            case 0: result[i] = 0; carry = 0; break;
            case -1: result[i] = -1; carry = 0; break;
            case -2: result[i] = 1; carry = -1; break;
            case -3: result[i] = 0; carry = -1; break;
            default: result[i] = 0; carry = 0;
          }
        }
        return result;
      },

      tritArrayToNumber(arr) {
        let num = 0;
        let power = 1;
        for(let i = arr.length - 1; i >= 0; i--) {
          num += (arr[i] || 0) * power;
          power *= 3;
        }
        return num;
      },

      numberToTritArray(num, size) {
        const arr = Array(size).fill(0);
        let n = num;
        // Using balanced ternary representation
        for (let i = size - 1; i >= 0 && (n !== 0 || i === size - 1) ; i--) {
          let rem = ((n % 3) + 3) % 3;
          n = Math.floor(n / 3);
          if (rem === 2) {
            rem = -1;
            n++;
          }
          arr[i] = rem;
        }
        return arr;
      },

      executeRemoteCommand() {
        this.logMessage("logRemote");
        const opcode = this.manualSwitches.nk.slice(0, 9);
        const operand = this.manualSwitches.nk.slice(9);

        this.ram[0] = {type: 'opcode', value: opcode};
        this.ram[1] = {type: 'operand', value: Array(18).fill(0)}; // Dummy operand, address comes from manual switches
        this.ram[1].value.splice(4, 5, ...this.manualSwitches.ao);

        this.ram[2] = {type: 'opcode', value: [-1,-1,-1]}; // Halt
        this.ram[3] = {type: 'operand', value: Array(18).fill(0)};

        this.pc = 0;
        this.halted = false;
        this.running = false;
        this.step(); // Execute just one command and then halt
      }
    };

    setun.init();
  });
</script>

</body>
</html>
